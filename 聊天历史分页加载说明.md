# ğŸ“œ èŠå¤©å†å²åˆ†é¡µåŠ è½½åŠŸèƒ½

## âœ… å·²å®ç°

èŠå¤©å†å²ç°åœ¨æ”¯æŒåˆ†é¡µåŠ è½½ï¼Œæ¯æ¬¡æ˜¾ç¤º 50 æ¡æ¶ˆæ¯ï¼Œä¸‹æ‹‰è‡ªåŠ¨åŠ è½½æ›´å¤šï¼

---

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. åˆå§‹åŠ è½½
- âœ… é¡µé¢æ‰“å¼€æ—¶è‡ªåŠ¨åŠ è½½æœ€è¿‘ 50 æ¡æ¶ˆæ¯
- âœ… å¦‚æœæ²¡æœ‰å†å²ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
- âœ… åŠ è½½å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨

### 2. ä¸‹æ‹‰åŠ è½½æ›´å¤š
- âœ… æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶è‡ªåŠ¨åŠ è½½æ›´å¤š
- âœ… æ¯æ¬¡åŠ è½½ 50 æ¡
- âœ… ä¿æŒæ»šåŠ¨ä½ç½®ä¸è·³åŠ¨
- âœ… æ˜¾ç¤ºåŠ è½½æç¤º

### 3. åŠ è½½çŠ¶æ€æç¤º
- âœ… "åŠ è½½å†å²æ¶ˆæ¯ä¸­..." - åŠ è½½æ—¶æ˜¾ç¤º
- âœ… "å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯" - æ²¡æœ‰æ›´å¤šæ—¶æ˜¾ç¤º
- âœ… é˜²æ­¢é‡å¤åŠ è½½

### 4. é‡ç½®åŠŸèƒ½
- âœ… ç‚¹å‡»é‡ç½®æŒ‰é’®
- âœ… åˆ›å»ºæ–° session
- âœ… æ¸…ç©ºå†å²åŠ è½½çŠ¶æ€
- âœ… é‡æ–°å¼€å§‹

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯ API

#### è·å–å†å²æ¶ˆæ¯ï¼ˆåˆ†é¡µï¼‰

**ç«¯ç‚¹**: `GET /api/v1/chat/history/{session_id}`

**å‚æ•°**:
- `session_id` (path): ä¼šè¯ ID
- `limit` (query): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 50
- `offset` (query): åç§»é‡ï¼Œé»˜è®¤ 0

**å“åº”**:
```json
{
  "session_id": "session_123_abc",
  "messages": [
    {
      "role": "user",
      "content": "ä½ å¥½",
      "timestamp": "2026-01-02T15:30:00.000Z"
    },
    {
      "role": "assistant",
      "content": "æ‚¨å¥½ï¼",
      "timestamp": "2026-01-02T15:30:01.000Z"
    }
  ],
  "total": 150,
  "has_more": true,
  "offset": 0,
  "limit": 50
}
```

**ç¤ºä¾‹è¯·æ±‚**:
```bash
# è·å–ç¬¬ä¸€é¡µï¼ˆæœ€è¿‘ 50 æ¡ï¼‰
GET /api/v1/chat/history/session_123_abc?limit=50&offset=0

# è·å–ç¬¬äºŒé¡µï¼ˆæ¥ä¸‹æ¥ 50 æ¡ï¼‰
GET /api/v1/chat/history/session_123_abc?limit=50&offset=50

# è·å–ç¬¬ä¸‰é¡µ
GET /api/v1/chat/history/session_123_abc?limit=50&offset=100
```

### å‰ç«¯å®ç°

#### çŠ¶æ€ç®¡ç†

```typescript
// å†å²æ¶ˆæ¯åŠ è½½çŠ¶æ€
const [isLoadingHistory, setIsLoadingHistory] = useState(false);  // æ˜¯å¦æ­£åœ¨åŠ è½½
const [hasMoreHistory, setHasMoreHistory] = useState(true);       // æ˜¯å¦è¿˜æœ‰æ›´å¤š
const [historyOffset, setHistoryOffset] = useState(0);            // å½“å‰åç§»é‡
const [isInitialLoad, setIsInitialLoad] = useState(true);         // æ˜¯å¦é¦–æ¬¡åŠ è½½
```

#### åŠ è½½å‡½æ•°

```typescript
const loadChatHistory = async (offset: number = 0, isInitial: boolean = false) => {
  if (isLoadingHistory || (!hasMoreHistory && !isInitial)) return;
  
  setIsLoadingHistory(true);
  
  try {
    const response = await fetch(
      `http://localhost:8001/api/v1/chat/history/${sessionId}?limit=50&offset=${offset}`
    );
    
    const data = await response.json();
    
    if (data.messages && data.messages.length > 0) {
      const historyMessages = data.messages.map((msg: any) => ({
        role: msg.role,
        content: msg.content,
        timestamp: new Date(msg.timestamp)
      }));
      
      if (isInitial) {
        // åˆå§‹åŠ è½½ï¼šæ›¿æ¢æ¬¢è¿æ¶ˆæ¯
        setMessages(historyMessages);
      } else {
        // ä¸‹æ‹‰åŠ è½½ï¼šæ·»åŠ åˆ°é¡¶éƒ¨
        setMessages(prev => [...historyMessages, ...prev]);
      }
      
      setHistoryOffset(offset + data.messages.length);
      setHasMoreHistory(data.has_more);
    }
  } catch (error) {
    console.error('åŠ è½½å†å²å¤±è´¥:', error);
  } finally {
    setIsLoadingHistory(false);
  }
};
```

#### æ»šåŠ¨ç›‘å¬

```typescript
const handleScroll = (e: React.UIEvent<HTMLDivElement>) => {
  const target = e.currentTarget;
  
  // æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶åŠ è½½æ›´å¤š
  if (target.scrollTop === 0 && hasMoreHistory && !isLoadingHistory) {
    const previousScrollHeight = target.scrollHeight;
    
    loadChatHistory(historyOffset).then(() => {
      // ä¿æŒæ»šåŠ¨ä½ç½®
      requestAnimationFrame(() => {
        const newScrollHeight = target.scrollHeight;
        target.scrollTop = newScrollHeight - previousScrollHeight;
      });
    });
  }
};
```

---

## ğŸ“Š åŠ è½½æµç¨‹

### åœºæ™¯ 1ï¼šé¦–æ¬¡æ‰“å¼€é¡µé¢

```
1. ç”¨æˆ·æ‰“å¼€é¡µé¢
   â†“
2. è·å– session_id: "session_123_abc"
   â†“
3. è°ƒç”¨ API: GET /history/session_123_abc?limit=50&offset=0
   â†“
4. è¿”å›æœ€è¿‘ 50 æ¡æ¶ˆæ¯
   â†“
5. æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢
   â†“
6. æ»šåŠ¨åˆ°åº•éƒ¨
```

### åœºæ™¯ 2ï¼šä¸‹æ‹‰åŠ è½½æ›´å¤š

```
1. ç”¨æˆ·æ»šåŠ¨åˆ°é¡¶éƒ¨
   â†“
2. è§¦å‘ handleScroll
   â†“
3. æ£€æŸ¥ï¼šscrollTop === 0 && hasMoreHistory && !isLoadingHistory
   â†“
4. è°ƒç”¨ API: GET /history/session_123_abc?limit=50&offset=50
   â†“
5. è¿”å›æ¥ä¸‹æ¥ 50 æ¡æ¶ˆæ¯
   â†“
6. æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨é¡¶éƒ¨
   â†“
7. ä¿æŒæ»šåŠ¨ä½ç½®ï¼ˆä¸è·³åŠ¨ï¼‰
   â†“
8. æ›´æ–° offset: 100
```

### åœºæ™¯ 3ï¼šåŠ è½½å®Œæ‰€æœ‰å†å²

```
1. ç”¨æˆ·ç»§ç»­ä¸‹æ‹‰
   â†“
2. API è¿”å›: has_more = false
   â†“
3. è®¾ç½® hasMoreHistory = false
   â†“
4. æ˜¾ç¤º "å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯"
   â†“
5. ä¸å†è§¦å‘åŠ è½½
```

---

## ğŸ® ç”¨æˆ·ä½“éªŒ

### åˆå§‹åŠ è½½

```
[åŠ è½½ä¸­...]
  â†“
[æ˜¾ç¤ºæœ€è¿‘ 50 æ¡æ¶ˆæ¯]
  â†“
[è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨]
```

### ä¸‹æ‹‰åŠ è½½

```
[ç”¨æˆ·æ»šåŠ¨åˆ°é¡¶éƒ¨]
  â†“
[æ˜¾ç¤º "åŠ è½½å†å²æ¶ˆæ¯ä¸­..."]
  â†“
[åŠ è½½å®Œæˆï¼Œæ·»åŠ  50 æ¡æ¶ˆæ¯]
  â†“
[ä¿æŒæ»šåŠ¨ä½ç½®]
  â†“
[ç”¨æˆ·å¯ä»¥ç»§ç»­æŸ¥çœ‹]
```

### åŠ è½½å®Œæ¯•

```
[ç”¨æˆ·æ»šåŠ¨åˆ°é¡¶éƒ¨]
  â†“
[æ˜¾ç¤º "å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯"]
  â†“
[ä¸å†åŠ è½½]
```

---

## ğŸ’¡ æ€§èƒ½ä¼˜åŒ–

### 1. é˜²æŠ–å¤„ç†
- é˜²æ­¢å¿«é€Ÿæ»šåŠ¨æ—¶é‡å¤åŠ è½½
- ä½¿ç”¨ `isLoadingHistory` æ ‡å¿—

### 2. æ»šåŠ¨ä½ç½®ä¿æŒ
- åŠ è½½æ–°æ¶ˆæ¯åä¿æŒæ»šåŠ¨ä½ç½®
- é¿å…ç•Œé¢è·³åŠ¨

### 3. æŒ‰éœ€åŠ è½½
- åªåŠ è½½éœ€è¦çš„æ¶ˆæ¯
- ä¸ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨

### 4. ç¼“å­˜æœºåˆ¶
- å·²åŠ è½½çš„æ¶ˆæ¯ä¿å­˜åœ¨çŠ¶æ€ä¸­
- ä¸é‡å¤è¯·æ±‚

---

## ğŸ” è°ƒè¯•ä¿¡æ¯

### å‰ç«¯æ§åˆ¶å°

```javascript
// æŸ¥çœ‹å½“å‰çŠ¶æ€
console.log('åŠ è½½çŠ¶æ€:', isLoadingHistory);
console.log('è¿˜æœ‰æ›´å¤š:', hasMoreHistory);
console.log('å½“å‰åç§»:', historyOffset);
console.log('æ¶ˆæ¯æ•°é‡:', messages.length);

// è¾“å‡ºç¤ºä¾‹
ğŸ“š åŠ è½½äº† 50 æ¡å†å²æ¶ˆæ¯
ğŸ“š åŠ è½½äº† 50 æ¡å†å²æ¶ˆæ¯
ğŸ“­ æ²¡æœ‰æ›´å¤šå†å²æ¶ˆæ¯
```

### åç«¯æ—¥å¿—

```
è·å–èŠå¤©å†å²: session_id=session_123_abc, limit=50, offset=0
è·å–èŠå¤©å†å²: session_id=session_123_abc, limit=50, offset=50
è·å–èŠå¤©å†å²: session_id=session_123_abc, limit=50, offset=100
```

---

## ğŸ“ API é›†æˆè¯´æ˜

### å½“å‰çŠ¶æ€

**åç«¯ API**:
- âœ… å·²å®ç°åˆ†é¡µæ¥å£
- â³ éœ€è¦è¿æ¥ Memory ç³»ç»Ÿ

**å‰ç«¯**:
- âœ… å·²å®ç°åŠ è½½é€»è¾‘
- âœ… å·²å®ç°ä¸‹æ‹‰åŠ è½½
- âœ… å·²å®ç°çŠ¶æ€ç®¡ç†

### TODO: è¿æ¥ Memory ç³»ç»Ÿ

éœ€è¦åœ¨ `backend/agent_person/api/chat.py` ä¸­å®ç°ï¼š

```python
@router.get("/history/{session_id}")
async def get_chat_history(session_id: str, limit: int = 50, offset: int = 0):
    # TODO: ä» memory ç³»ç»Ÿè·å–å†å²
    brain_client = get_brain_client()
    
    # è°ƒç”¨ memory ç³»ç»Ÿ API
    history = await brain_client.get_session_history(
        session_id=session_id,
        limit=limit,
        offset=offset
    )
    
    return {
        "session_id": session_id,
        "messages": history.messages,
        "total": history.total,
        "has_more": history.has_more,
        "offset": offset,
        "limit": limit
    }
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·æ“ä½œæµç¨‹

1. **æ‰“å¼€é¡µé¢**
   - è‡ªåŠ¨åŠ è½½æœ€è¿‘ 50 æ¡æ¶ˆæ¯
   - çœ‹åˆ°å†å²å¯¹è¯

2. **æŸ¥çœ‹æ›´æ—©çš„æ¶ˆæ¯**
   - æ»šåŠ¨åˆ°é¡¶éƒ¨
   - è‡ªåŠ¨åŠ è½½æ›´å¤š 50 æ¡
   - ç»§ç»­æ»šåŠ¨æŸ¥çœ‹

3. **å‘é€æ–°æ¶ˆæ¯**
   - è¾“å…¥å¹¶å‘é€
   - æ–°æ¶ˆæ¯æ·»åŠ åˆ°åº•éƒ¨
   - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

4. **é‡ç½®å¯¹è¯**
   - ç‚¹å‡»é‡ç½®æŒ‰é’®
   - åˆ›å»ºæ–° session
   - å¼€å§‹æ–°å¯¹è¯

---

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¿®æ”¹æ¯é¡µæ•°é‡

åœ¨ `DigitalPersonPage.tsx` ä¸­ï¼š

```typescript
// ä¿®æ”¹ä¸ºæ¯æ¬¡åŠ è½½ 100 æ¡
const response = await fetch(
  `http://localhost:8001/api/v1/chat/history/${sessionId}?limit=100&offset=${offset}`
);
```

åœ¨ `chat.py` ä¸­ï¼š

```python
# ä¿®æ”¹é»˜è®¤å€¼
async def get_chat_history(
    session_id: str, 
    limit: int = 100,  # æ”¹ä¸º 100
    offset: int = 0
):
```

### ä¿®æ”¹åŠ è½½è§¦å‘ä½ç½®

```typescript
// åœ¨è·ç¦»é¡¶éƒ¨ 100px æ—¶è§¦å‘
if (target.scrollTop < 100 && hasMoreHistory && !isLoadingHistory) {
  loadChatHistory(historyOffset);
}
```

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°åŠŸèƒ½

1. âœ… **åˆ†é¡µåŠ è½½** - æ¯æ¬¡ 50 æ¡
2. âœ… **ä¸‹æ‹‰åŠ è½½** - æ»šåŠ¨åˆ°é¡¶éƒ¨è‡ªåŠ¨åŠ è½½
3. âœ… **åˆå§‹åŠ è½½** - æ‰“å¼€é¡µé¢è‡ªåŠ¨åŠ è½½
4. âœ… **åŠ è½½æç¤º** - æ˜¾ç¤ºåŠ è½½çŠ¶æ€
5. âœ… **ä½ç½®ä¿æŒ** - åŠ è½½åä¸è·³åŠ¨
6. âœ… **é˜²é‡å¤** - é¿å…é‡å¤åŠ è½½
7. âœ… **é‡ç½®åŠŸèƒ½** - æ¸…ç©ºå¹¶é‡æ–°å¼€å§‹

### ç”¨æˆ·ä½“éªŒ

- ğŸš€ **å¿«é€ŸåŠ è½½** - åªåŠ è½½éœ€è¦çš„æ¶ˆæ¯
- ğŸ“œ **æ— é™æ»šåŠ¨** - è‡ªåŠ¨åŠ è½½æ›´å¤š
- ğŸ’« **æµç•…ä½“éªŒ** - æ»šåŠ¨ä½ç½®ä¿æŒ
- ğŸ¯ **æ¸…æ™°æç¤º** - åŠ è½½çŠ¶æ€æ˜ç¡®

### æŠ€æœ¯ä¼˜åŠ¿

- ğŸ”§ **å¯æ‰©å±•** - æ˜“äºè°ƒæ•´é…ç½®
- ğŸ¨ **å¯ç»´æŠ¤** - ä»£ç ç»“æ„æ¸…æ™°
- ğŸš€ **é«˜æ€§èƒ½** - æŒ‰éœ€åŠ è½½
- ğŸ”’ **å¯é æ€§** - é”™è¯¯å¤„ç†å®Œå–„

---

**äº«å—æµç•…çš„èŠå¤©å†å²æµè§ˆä½“éªŒï¼** ğŸ“œâœ¨
