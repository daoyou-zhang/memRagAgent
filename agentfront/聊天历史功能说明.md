# 💬 聊天历史持久化功能

## ✅ 已实现

聊天记录现在会自动保存到浏览器的 localStorage，刷新页面后聊天历史不会丢失！

---

## 🎯 功能特性

### 1. 自动保存
- ✅ 每次发送或接收消息时自动保存
- ✅ 保存到浏览器 localStorage
- ✅ 最多保存 100 条消息
- ✅ 超过限制时自动清理旧消息

### 2. 自动加载
- ✅ 页面刷新后自动恢复聊天历史
- ✅ 保留消息时间戳
- ✅ 保留用户和助手的对话

### 3. 重置功能
- ✅ 点击刷新按钮清空聊天历史
- ✅ 重置为欢迎消息
- ✅ 同时清除 localStorage

---

## 📁 文件结构

```
agentfront/src/
├── utils/
│   └── chatStorage.ts          # 聊天历史存储工具
└── pages/
    └── DigitalPersonPage.tsx   # 使用存储工具
```

---

## 🔧 核心功能

### chatStorage.ts 提供的工具函数

#### 1. loadChatHistory()
```typescript
// 加载聊天历史
const messages = loadChatHistory();
```

#### 2. saveChatHistory(messages)
```typescript
// 保存聊天历史
saveChatHistory(messages);
```

#### 3. resetChatHistory()
```typescript
// 重置为欢迎消息
const welcomeMessages = resetChatHistory();
```

#### 4. clearChatHistory()
```typescript
// 清除所有聊天历史
clearChatHistory();
```

#### 5. exportChatHistory(messages)
```typescript
// 导出聊天历史为 JSON 文件
exportChatHistory(messages);
```

#### 6. importChatHistory(file)
```typescript
// 从 JSON 文件导入聊天历史
const messages = await importChatHistory(file);
```

#### 7. getChatStats(messages)
```typescript
// 获取聊天统计信息
const stats = getChatStats(messages);
// {
//   totalMessages: 10,
//   userMessages: 5,
//   assistantMessages: 5,
//   firstMessageTime: Date,
//   lastMessageTime: Date
// }
```

---

## 💾 存储机制

### localStorage 存储

**存储键**: `chatHistory`

**存储格式**:
```json
[
  {
    "role": "assistant",
    "content": "你好！我是道友...",
    "timestamp": "2026-01-02T15:30:00.000Z"
  },
  {
    "role": "user",
    "content": "你好",
    "timestamp": "2026-01-02T15:30:10.000Z"
  }
]
```

### 存储限制

- **最大消息数**: 100 条
- **存储空间**: 约 5-10 MB（取决于浏览器）
- **自动清理**: 超过 100 条时保留最新的 100 条

### 错误处理

如果存储空间不足：
1. 自动清理，只保留最近 50 条消息
2. 在控制台显示警告
3. 继续正常运行

---

## 🎮 使用方式

### 用户操作

1. **正常聊天**
   - 发送消息
   - 接收回复
   - 自动保存

2. **刷新页面**
   - 按 F5 或刷新按钮
   - 聊天历史自动恢复
   - 继续之前的对话

3. **重置对话**
   - 点击右上角刷新按钮
   - 清空所有聊天记录
   - 重新开始对话

### 开发者操作

```typescript
import { 
  loadChatHistory, 
  saveChatHistory, 
  exportChatHistory,
  getChatStats 
} from '../utils/chatStorage';

// 加载历史
const messages = loadChatHistory();

// 保存历史
saveChatHistory(messages);

// 导出历史
exportChatHistory(messages);

// 获取统计
const stats = getChatStats(messages);
console.log(`共 ${stats.totalMessages} 条消息`);
```

---

## 🔒 隐私和安全

### 数据存储位置
- ✅ 存储在**本地浏览器**
- ✅ 不会上传到服务器
- ✅ 只在当前浏览器可见

### 数据清除方式

**方法 1：点击重置按钮**
- 在聊天界面点击刷新按钮

**方法 2：清除浏览器数据**
- Chrome: 设置 → 隐私和安全 → 清除浏览数据
- 选择 "Cookie 和其他网站数据"

**方法 3：开发者工具**
- F12 打开开发者工具
- Application → Local Storage
- 删除 `chatHistory` 键

**方法 4：代码清除**
```typescript
import { clearChatHistory } from '../utils/chatStorage';
clearChatHistory();
```

---

## 📊 存储容量

### 估算

- 每条消息约 100-200 字节
- 100 条消息约 10-20 KB
- localStorage 限制通常为 5-10 MB
- 可以存储数千条消息

### 监控

在浏览器控制台查看：
```javascript
// 查看当前存储大小
const data = localStorage.getItem('chatHistory');
console.log(`存储大小: ${(data?.length || 0) / 1024} KB`);

// 查看消息数量
const messages = JSON.parse(data || '[]');
console.log(`消息数量: ${messages.length}`);
```

---

## 🚀 高级功能

### 1. 导出聊天记录

```typescript
import { exportChatHistory } from '../utils/chatStorage';

// 导出为 JSON 文件
exportChatHistory(messages);
// 下载文件: chat-history-2026-01-02.json
```

### 2. 导入聊天记录

```typescript
import { importChatHistory } from '../utils/chatStorage';

// 从文件导入
const fileInput = document.createElement('input');
fileInput.type = 'file';
fileInput.accept = '.json';
fileInput.onchange = async (e) => {
  const file = (e.target as HTMLInputElement).files?.[0];
  if (file) {
    const messages = await importChatHistory(file);
    setMessages(messages);
  }
};
fileInput.click();
```

### 3. 聊天统计

```typescript
import { getChatStats } from '../utils/chatStorage';

const stats = getChatStats(messages);
console.log(`
  总消息数: ${stats.totalMessages}
  用户消息: ${stats.userMessages}
  助手消息: ${stats.assistantMessages}
  首条消息: ${stats.firstMessageTime}
  最后消息: ${stats.lastMessageTime}
`);
```

---

## 🐛 故障排除

### 问题 1：刷新后聊天记录丢失

**原因**：localStorage 被禁用或清除

**解决**：
1. 检查浏览器设置，确保允许 localStorage
2. 检查是否在隐私模式（无痕模式）
3. 检查浏览器扩展是否阻止了存储

### 问题 2：保存失败

**原因**：存储空间不足

**解决**：
- 系统会自动清理旧消息
- 或手动清除浏览器数据

### 问题 3：时间戳显示错误

**原因**：时区问题

**解决**：
- 时间戳使用 ISO 格式存储
- 显示时会自动转换为本地时间

---

## 📝 更新日志

### v1.0.0 (2026-01-02)
- ✅ 实现聊天历史自动保存
- ✅ 实现聊天历史自动加载
- ✅ 实现重置功能
- ✅ 添加存储工具函数
- ✅ 添加错误处理
- ✅ 添加存储限制（100 条）
- ✅ 添加自动清理机制

---

## 🎉 总结

### 现在你可以：

1. ✅ **放心聊天** - 消息自动保存
2. ✅ **随时刷新** - 历史记录不丢失
3. ✅ **重新开始** - 一键清空历史
4. ✅ **导出备份** - 保存聊天记录
5. ✅ **查看统计** - 了解聊天情况

### 技术特点：

- ✅ 自动保存，无需手动操作
- ✅ 本地存储，保护隐私
- ✅ 智能清理，节省空间
- ✅ 错误处理，稳定可靠
- ✅ 易于扩展，功能丰富

---

**享受你的持久化聊天体验！** 💬✨
